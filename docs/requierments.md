# 要件定義書：Ad-lib Mate (アドリブ・メイト)

**最終更新日:** 2025 年 12 月 29 日
**バージョン:** 1.2 (Gemini 3 最新モデル対応版)

## 1. プロジェクト概要

- **プロジェクト名:** Ad-lib Mate (アドリブ・メイト)
- **コンセプト:** ジャズミュージシャンのための「AI 即興演奏パートナー」。
- **課題:** 初心者はコード進行を見ても「何の音を吹けばいいかわからない」し、音楽理論の壁に挫折しがち。
- **解決策:** 楽譜をカメラで読み取り、AI の推論で「理論的に正しくてカッコいい」ソロを生成し、リアルな音源でお手本を示すアプリ。
- **ターゲット:**
  - ビッグバンド所属の学生（高校生・大学生）。
  - 社会人アマチュアバンドマン。
  - 楽器（サックス、トランペット、トロンボーン、ピアノ）の練習をしているジャズ初心者。

---

## 2. システム構成 (アーキテクチャ)

### 2.1 技術スタック

- **Frontend:** Next.js 16 (App Router / TypeScript)
- **Backend:** Python 3.14.2 (FastAPI)
- **AI Engine:** Google Gemini 3 ecosystem & Lyria
- **Database:** Supabase (PostgreSQL) - _MVP 段階ではオプション_

### 2.2 データフロー

1.  **入力:** ユーザーが楽譜（C 譜など）をスマホで撮影 → バックエンドへ送信。
2.  **解析 (Vision):** `gemini-3-flash-preview` が画像からコード進行テキストを抽出。
3.  **推論 (Reasoning):** `gemini-3-pro-preview` (設定: `thinking_level: high`) が楽曲構造を分析し、使用すべきスケールやターゲットノートを決定。
4.  **作曲 (Composition):** `music21` (Python ライブラリ) が AI の論理に基づいて実際の音符データ(MIDI)を構築。
5.  **音声合成 (Audio):** `lyria-realtime-exp` が MIDI/構造データをもとに、リアルな楽器音を生成。
6.  **表示 (UI):** フロントエンドで楽譜を描画し、音声を再生。

---

## 3. 機能要件

### 3.1 コード入力・解析機能 ("Vision" モジュール)

- **カメラ撮影:**
  - 機能: 紙の楽譜（リードシート）を撮影して取り込む。
  - 技術: HTML5 Media Capture / Native Camera API。
  - AI モデル: **`gemini-3-flash-preview`**
    - 選定理由: 画像処理のレスポンスが爆速で、テキスト抽出精度が高いため。
- **テキスト入力:**
  - 機能: 手動でのコード入力・修正（例: `| Dm7 | G7 | Cmaj7 |`）。

### 3.2 アドリブソロ生成機能 ("Brain" モジュール)

- **設定パラメータ:**
  - **難易度:** 初級 (コードトーン主体) / 中級 (スケール活用) / 上級 (アウト・リハモあり)。
  - **楽器:** 移調に対応 (C, Bb, Eb)。
  - **雰囲気:** Swing, Bossa Nova, Funk など。
- **生成ロジック:**
  - 技術: **`gemini-3-pro-preview`**
    - 設定: `{"thinking_level": "high", "temperature": 0.7}`
    - 役割: 単なる確率的な生成ではなく、「なぜこの音なのか」という**音楽理論的な推論(Reasoning)**を行い、フレーズの説得力を高める。
  - 技術: **`music21`**
    - 役割: 音楽理論のルール（ボイシング、音域制限）の適用と、MusicXML/MIDI オブジェクトの生成。

### 3.3 再生・視聴機能 ("Sound" モジュール)

- **音声合成:**
  - 技術: **`lyria-realtime-exp`** (Vertex AI 経由)
    - 役割: バッキングトラックのスタイルに合わせた、人間らしいニュアンスの演奏オーディオを生成。
  - フォールバック: `Tone.js` (Web Audio API) - API 遅延時の簡易再生用。

### 3.4 ユーザーインターフェース ("Face")

- **楽譜ビューア:**
  - 技術: **`opensheetmusicdisplay`** (OSMD)
  - 機能: 生成されたソロを標準的な五線譜としてレンダリング。
  - インタラクティブ: 小節をタップすると「AI 先生の理論解説」が表示される。
- **練習モード:**
  - 機能: 指定範囲のループ再生、テンポ変更。

---

## 4. 非機能要件

- **パフォーマンス:**
  - 画像解析完了まで: 3 秒以内。
  - ソロ生成完了まで: 5 秒以内。
- **UI/UX:**
  - **ダークモード標準:** 薄暗い練習スタジオやステージ袖でも目に優しい設計。
  - **モバイルファースト:** 楽器を持ったまま片手で操作しやすい UI。
- **互換性:**
  - PWA (Progressive Web App) 対応により、電波の悪い地下スタジオでも保存済みデータの閲覧を可能にする。

---

## 5. 開発マイルストーン

1.  **フェーズ 1 (MVP):** テキスト入力 → ランダム生成 (Music21 のみ) → 楽譜表示まで。
2.  **フェーズ 2 (AI 統合):** `gemini-3-pro-preview` を繋いで「賢いソロ」にし、`gemini-3-flash-preview` でカメラ入力を実装。
3.  **フェーズ 3 (Audio 品質向上):** `lyria-realtime-exp` を導入し、本物の楽器のような音にする。
